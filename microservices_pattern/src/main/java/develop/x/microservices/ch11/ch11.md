# 11장 프로덕션 레디 서비스 개발

## 11.1 보안 서비스 개발
주요 보안 요소: 인증, 인가, 감사, 보안 IPC

### 11.1.1 기존 모놀리식 애플리케이스 보안 
### 11.1.2 마이크로서비스 아키텍처에서 보안 구현

#### API 게이트웨이에서 인증처리 
- 요청을 서비스에 보내기 전에 API 게이트웨이가 요청을 인증하는 것 좋다. 
- API 클라이언트는 자격증명을 포함시켜 요청을 전송하고 API 게이트웨이는 이 요청을 인증한다. 
- 액세스 토큰: API 게이트웨이는 신원, 역할 등 사용자 정보가 담긴 토큰을 자신이 호출하는 서비스에 전달한다.

#### 인가처리 
- 해당 클라이언트가 요청한 작업을 할 수 있도록 허가되었는지 검사하는 인가 매커니즘 
- API 게이트웨이는 역할 기반은 URL 경로 접근만 구현할 수 있다
- 개별 도메인 객체의 접근 권한을 제어하는 ACL은 각 서비스에 구현하는 것이 좋다. 

#### JWT로 사용자 신원/역할 전달
- 난독화 토큰: UUID 같은 고유 식별자로 하게 되면 사용자 정보를 조회하는 프로세스가 필요하다. 
- 투명 토큰: (JWT) 사용자 신원/역할 등이 안전하게 표현현하는 수단이다. 

#### OAuth 2.0 응용
- OAuth 2.0 표준이 제대로 구현된 기성 서비스나 프레임워크를 갖다 쓰면 된다. 
- OAuth 2.0은 깃허브나 구글 등 퍼블릭 클라우드 서비스 사용자가 자기 정보에 접근하려는 서드파티 애플리케이션을 패스워드 노출 없이 허가할 수 있는 방안을 찾다가 
정착된 인증 프로토콜이다.
- OAuth 2.0 의 핵심 개념
  - 인증 서버: 사용자 인증 및 액세스/리프레시 토큰 획득 API를 제공한다.(스피링 OAuth가 대표적인 프레임워크)
  - 액세스 토큰: 리소스 서버 접근을 허가하는 토큰 (JWT)
  - 리프레시 토큰: 클라이언트가 새 액세스 토큰을 얻기 위해 필요한 토큰 수명은 길지만 취소가 가능한 토큰
  - 리소스 서버: 액세스 토큰으로 접근을 허가하는 서비스
  - 클라이언트: 리소스 서버에 접근하려는 클라이언트, 마이크로서비스 아키텍처는 API 게이트웨이
- API 클라이언트 요청을 API 게이트웨이가 인증하는 과정
  - 1 클라이언트는 기본 인증을 이용하여 자격증명과 함께 요청
  - 2 API 게이트웨이는 OAuth 2.0 인증 서버에 패스워드 승인을 요청
  - 3 인증서버는 API 클라이언트의 자격증명을 검증하고 액세스/리프레시 토큰 반환
  - 4 API 게이트웨이는 서비에 요청시에 발급받은 액세스 토큰을 넣어 보내고, 서비스는 액세스 토큰을 이용하여 요청을 인증한다.

## 11.2 구성 가능한 서비스 설계
- 런타임에 구성 프로퍼티 값을 서비스에 제공하는 외부화 구성 매커니즘은 구현 방식에 따라 2가지가 존재
  - 푸시모델: OS 환경 변수, 구성 파일 등을 통해 배포 인프라에서 서비스 스스로 전달
  - 풀 모델: 서비스가 인스턴스가 구성 서버에 접속해서 프로퍼티 값을 읽어 온다.
  
### 11.2.1 푸시 기반의 외부화 구성 
- 배포 환경은 서비스 인스턴스가 생성될 때 프로퍼티 값을 제공한다. 
- 스프링 부트가 프로퍼티 값을 읽어 올 수 있는 소스는 다음과 같다. 
  - CLI 인수
  - JSON 포맷으로 기술된 JVM 시스템 프로퍼티ㅐ
  - JVM 시스템 프로퍼티
  - OS 환경 변수
  - 현재 디렉터리의 구성파일

### 11.2.2 풀 기반의 외부화 구성 
- 서비스 인스턴스가 시동 시 자신이 필요한 값을 구성 전용 서버에 접속하여 읽는 방식
- 구성 서버을 구현하는 여러 가지 방법
  - 버전 관리 시스템 (깃, SVN)
  - SQL/NoSQL DB
  - 전용 구성 서버 (스프링 클라우드 컨피그 서버)
- 구성 서버 장점
  - 중앙화 구성
  - 민감한 데이터의 투명한 복호화
  - 동적 재구성 

## 11.3 관측 가능한 서비스 설계
- 헬스 체크
- 로그 수집
- 분산 추적
- 예외 추적
- 애플리케이션 지표
- 감사 로깅

### 11.3.1 헬스 체크 API 패턴 
- 서비스 인스턴스는 자신이 요청을 처리할 수 있는 상태인지 여부를 배포 인프라에 알려야 한다.
- 헬스 체크 요청 핸들러는 서비스 인스턴스 및 외부 서비스의 접속 상태를 테스트한다.

### 11.3.2 로그 수집 패턴 
- 전체 서비스 로그를 중앙 DB에 수집하여 검색/알림 기능을 제공한다.
- 모든 서비스 인스턴스가 남긴 로그를 로그 수집 파이프라인을 통해 중앙 로깅 서버로 보내는 것이다. 

#### 서비스 로그 생성
- SLF4J 로깅 프레임 워크 퍼사드 역할을 수행하는 인터페이스
- 로깅 프레임워크 3총사 로그백, Log4J, JUL

#### 로그 수집 인프라
- 로깅 인프라는 로그를 수집 및 저장하며, 사용자는 저장된 로그를 검색할 수 있다. 
  - 일래스틱서치: 로깅 서버로 쓰이는 텍스트 검색 지향 NoSQL DB
  - 로그 스태시: 서비스 로그를 수집하여 일래스틱서치에 출력하는 로그 파이프라이
  - 키바나: 일래스틱서치 전용 시각화 툴

### 11.3.3 분산 추적 패턴
- 외부 요청마다 유일한 ID를 하나씩 부여해서 한 서비스에서 다음 서비스를 흘러가는 과정을 기록하고,
  시각화/분석 기능을 제공하는 중앙화 서버에 자료를 남긴다. 

#### 인스트루멘테이션 라이브러리
- 스팬 트리를 만들어 분산 추적 서버로 보내는 역할을 한다. AOP를 이용하는 것이 깔끔하다.

#### 분산 추적 서버
- 분산 추적 서버는 전달받은 스팬을 짜집기해서 완전한 트레이스 형태로 만들어 DB에 저장하는 역할
- 트위터가 개발한 오픈 집킨은 잘 알려진 분산 추적 서버

### 11.3.4 애플리케이션 지표 패턴
- 모니터링 시스템은 기술 스택의 모든 부분에서 지표를 수집하여 중요한 애플리케이션 헬스 정보를 제공한다. 
- 하드웨어에 CPU, 메모리, 디스크 사용률, 애플리케이션의 지연시간, 실행 요청 수 등

#### 서비스 수준의 지표 수집 
- 스프링 부트 기반의 서비스는 마이크로미터 매트릭스라는 라이브러리를 디펜던시로 추가하고 구성코드 몇 줄만 넣으면 기본 지표는 바로 수집 가능하다.
```java
import org.springframework.beans.factory.annotation.Autowired;

@Autowired
private MeterRegistry meterRegistry;
```

#### 지표 서비스에 지표 전달
- 서비스는 수집한 지표를 푸시 또는 풀 방식으로 매트릭스 서비스에 전달한다. 
- 푸시 모델은 서비스 인스턴스가 API를 호출하여 매트릭스 서비스에 지표를 밀어 넣는 방법이다. 
- 풀 모델은 매트릭스 서비스가 서비스 API를 호출하여 서비스 인스턴스에서 지표를 당겨오는 방법(프로매테우스)

### 11.3.5 예외 추적 패턴 
- 중복된 예외를 제거하고, 알림을 생성하고, 예외 해결 과정을 관리하는 예외 추적 서비스를 따로 두는 것이 좋다. 
- 여타 서비스에 예외가 발생하면 무조건 예외 추적 서비스에 보고하도록 구성

### 11.3.6 감사 로깅 패턴
- 감사 로깅은 각 사용자의 액션을 기록하는 것이다. 
- 고객 지원 컴플라이언스 준수, 수상한 동작 감지를 위해 사용자 액션을 DB에 저장한다. 


## 11.4 서비스 개발: 마이크로서비스 섀시 패턴 
- 예외 추적, 로깅, 헬스 체크, 외부화 구성, 분산 추적 등의 횡단 관심사를 처리하는 프레임워크들을 기반으로 서비스를 구축하는 패턴

### 11.4.1 마이크로서비스 섀시 
- 마이크로서비스 섀시 프레임워크는 다양한 관심사를 처리한다. 
- 외부화 구성, 헬스 체크, 애플리케이션 지표, 회로 차단기, 분산추적

### 11.4.2 이제는 서비스 메시로 
- 회로 차단기, 분산 추적, 서비스 디스커버리, 부하 분산, 룰 기반 트래픽 라우팅 등 다양한 관심사가 구현된 네트워크 계층을 통해 서비스를 
 드나드는 모든 네트워크 트래픽을 라우팅한다.











