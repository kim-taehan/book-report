# 6장 비지니스 로직 개발: 이벤트 소싱

## 6.1 이벤트 소싱 응용 비지니스 로직 개발
- 이벤트 소싱은 비지니스 로직을 구성하고 애그리거트를 저장하는 또 다른 방법으로 애그리거트를 일련의 이벤트 형태로 저장한다. (이력처럼)

### 6.1.1 기존 영속화의 문제점 
#### 객체-관계 임피던스 부정합
- 관계형 데이터베이스 테이블과 객체는 구조부터 다르다

#### 애그리거트 이력이 없다. 
- 기존 영속화 매커니즘은 현재 애그리거트의 상태만 저장한다.

#### 검사 로깅은 구현하기 힘들고 오류도 자주 발생한다. 

#### 이벤트 발행 로직이 비지니스 로직에 추가된다. 
- 기존 영속화의 다른 한계는 도메인 이벤트 발행을 지원하지 않는 점이다. 도메인 이벤트는 애그리거트가 자신의 상태를 변경한 후 발행하는 이벤트이다. 
- 마이크로서비스 아키텍처에서는 데이터를 동기화하고 알림을 전송하는 용도로 사용된다. 


### 6.1.2 이벤트 소싱 개요
- 이벤트 소싱은 이벤트를 위주로 비즈니스 로직을 구현하고, 애그리거트를 DB에 일련의 이벤트로 저장하는 기법이다. 
- 각 이벤트는 애그리거트의 상태 변화를 나타내고, 비지니스 로직은 이벤트를 생산/소비하는 요건 중심으로 구성된다. 

#### 이벤트를 이용하여 애그리거트를 저장
- Order 애그리거트를 이벤트 소싱으로 저장하면 Order 애그리거트를 EVENTS 테이블의 여러 로우로 저장된다. 
- 주문생성됨, 주문 승인됨, 주문 배달됨 등의 상태들이 각각 row 저장된다. 
- reduce()는 배열의 각 요소에 대하여 reducer 함수를 실행하고, map과 filter와 달리 배열이 아닌 하나의 결과값을 반환

#### 이벤트는 곧 상태 변화
- 도메인 이벤트는 애그리거트의 변경을 구독자에게 알리는 장치로 이벤트는 애그리거트 ID 같은 최소한의 필수 데이터만 넣거나 
  컨슈머에 유용한 데이터까지 포함시켜 강화할 수 있다. 

#### 애그리거트 메서드의 관심사는 오직 이벤트 
- 비지니스 로직은 애그리거트의 업데이트 요청을 애그리거트 루트에 있는 커맨드 메서드를 호출하여 처리한다. 
- 이벤트 소싱을 사용하면 커멘드 메시지가 반드시 이벤트를 발생시킨다. 
- 애그리거트의 커맨드 메서드를 호출한 결과는 상태 변경을 나타내는 일련의 이벤트이다. 


### 6.1.3 동시 업데이트: 낙관적 잠금
- 여러 요청이 동일한 애그리거트를 동시에 업데이트하는 일은 드물지 않습니다. 
- 기존 영속화 매커니즘은 대개 한 트랜잭션이 다른 트랜잭션의 변경을 덮어 쓰지 못하게 낙관적 잠금(버전 컬럼 활용)으로 처리한다. 
- 이벤트 저장소 역시 낙관적 잠금 기법으로 동시 업데이트를 처리할 수 있다. 

### 6.1.4 이벤트 소싱과 이벤트 발행

#### 이벤트 플링
- 이벤트 발행기는 select 문으로 새 이벤트를 계속 풀링하면서 메시지 브로커에 발행 할 수 있다. 

#### 이벤트 발행: 트랜잭션 로그 테일링
- DB 트랜잭션 로그를 통해 EVENT 테이블에 삽입된 이벤트를 읽어 메시지 브로커에 발행한다. 


### 6.1.5 스냅샷으로 성능 개선
- 주기적으로 애그리거트 상태의 스냅샷을 저장한다. 
- 그리고 최근에 뜬 스냅샷과 그 이후 발생한 이벤트만 가져오는 식으로 애그리거트 상태를 복원할 수 있다. 

### 6.1.6 멱등한 메시지 처리 
- 메시지 브로커가 동일한 메시지를 여러 번 전송할 가능성이 있으므로 메시지 컨슈머는 멱등하게 개발해야 한다. 

### 6.1.7 도메인 이벤트 발전시키기

#### 이벤트 스키마 
- 이벤트 소싱에 기반한 애플리케이션의 스키마는 개념상 다음 세 가지로 구성
  - 하나 이상의 애그리거트로 구성
  - 각 애그리거트가 발생시키는 이벤트를 정의
  - 이벤트 구조를 정의

### 6.1.8 이벤트 소싱 장점
- 도메인 이벤트를 확실하게 발행
- 애그리거트 이력 보존
- O/R 임피던스 불일치 문제를 방지 
- 개발자에게 타임 머신 제공

### 6.1.9 이벤트 소싱 단점
- 새로운 프로그래밍 모델을 배워아야 한다.
- 메시징 기반 애플리케이션은 복잡하다.
- 이벤트를 발전시키기 어렵다
- 데이터를 삭제하기 어렵다
- 이벤트 저장소를 쿼리하기 어렵다. 
