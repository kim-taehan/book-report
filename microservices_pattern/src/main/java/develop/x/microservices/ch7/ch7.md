# 7장 마이크로서비스 쿼리 구현

## 7.1 API 조합 패턴 응용 쿼리 
- 서비스 클라이언트가 데이터를 가진 여러 서비스를 직접 호출하여 그 결과를 조합하는 패턴

### 7.1.1 findOrder() 쿼리 
- 모놀로식에서는 여러 테이블을 조인해서 사용하지만 마이크로서비스에서는 데이터가 여러 서비스에 나눠져 있다.
- 클라이언트가 주문 내역을 조회하기 위해서는 모든 서비스에 요청을 해야 한다. 

### 7.1.2 API 조합패턴 개요
- API 조합기: 프로바이더 서비스를 쿼리하여 데이터를 조회한다. 
- 프로바이더 서비스: 최종 결과로 반환할 데이터의 일부를 가지고 있는 서비스

### 7.1.3 API를 조합 패턴으로 findOrder() 쿼리 구현
- findOrder() 는 4개의 서비스를 호출한 결과를 조합한다.

### 7.1.4 API 조합 설계 이슈
#### 누가 API 조합기 역할을 맡을 것인가?
- 서비스 클래이언트를 API 조합기로 임명
- 애플리케이션 외부 API가 구현된 API 게이트웨이를 API 조합기로 만드는 것
- 스탠드얼론 서비스로 구현

#### API 조합기는 리액티브 프로그래밍 모델을 사용해야 한다. 
- CompletableFuture, RxJava의 옵저버 등을 사용

### 7.1.5 API 조합 패턴의 장단점
- API 조합 패턴은 아주 쉽고 단순하게 쿼리 작업을 구현할 수 있지만 단점도 존재한다.
  - 오버헤드 증가
  - 가용성이 저하될 우려가 있다.
  - 데이터 일관성이 결여된다.

## 7.2 CQRS 패턴
- 엔터프라이즈 애플리케이션은 대부분 RDBMS에 트랜잭션을 걸어 레코드를 관리하고 
텍스트 검색 쿼리는 일랙스틱서치나 솔라 등의 테스트 검색 DB를 이용해서 구현한다. 
- CQRS는 커맨드 쿼리 책임 분리 패턴으로 읽기 전용 뷰를 사용해서 쿼리를 할 수 있게 해주는 기법

### 7.2.1 CQRS 필요성
- 여러가지 조건으로 리스트를 검색하는 쿼리는 조건이 특정 서비스에는 맞지 않는 내용이 있을 수도 있기에 대량의 데이터가 내려올 수 있다. 
- 관심사를 분리할 수 있다. 
 
### 7.2.2 CQRS 개요
#### CQRS 는 커맨드와 쿼리를 서로 분리한다.
- CQRS 는 이름처럼 관심사의 분리/구분에 관한 패턴으로 커맨드와 쿼리 두 편으로 가른다. 
- 조회 기능과 생성/수정/삭제 기능으로 나누고 커맨드쪽에서 발행한 이벤트를 쿼리 쪽에서 구독하는 방식


#### 7.2.3 CQRS 장점
- 마이크로서비스 아키텍처에서 쿼리를 효율적으로 구현할 수 있다. 
- 다양한 쿼리를 효율적으로 구현할 수 있다. 
- 이벤트 소싱 애플리케이션에서 쿼리가 가능하다.
- 관심사가 더 분리된다. 

#### 7.2.4 CQRS 단점
- 아키텍처가 복잡하다
- 복제 시차가 존재한다.

## 7.3 CQRS 뷰 설계
- DB를 선정하고 스키마 설계
- 데이터 접근 모듈을 설계시 명등한/동시 업데이트 등의 문제를 고려
- 뷰를 효율적으로 빌드할 수 있는 수단
- 복제 시차 처리방안 


