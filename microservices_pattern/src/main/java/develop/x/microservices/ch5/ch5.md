# 5장 비지니스 로직 설계

## 5.1 비지니스 로직 구성 패턴
- 주문 서비스는 중심에 비지니스 로직이 있고 인바운드/아웃바운드 어댑터가 주변을 감싼 육각형 아키텍처 구조이다.
- 인바운드 어댑터는 클래이언트 요청을 받아 비지니스 로직을 호출한다.
- 아웃바운드 어댑터는 다른 서비스 및 애플리케이션을 실행한다.
- 주문 서비스는 비지니스 로직과 다음 어댑터로 구성된다. 
  - REST API 어댑터: 비지니스 로직을 호출하는 REST API가 구현된 인바운드 어댑터
  - OrderCommandHandlers: 메시지 채널에서 들어온 커맨드 메시지를 받아 비지니스 로직을 호출하는 인바운드 어댑터
  - DB 어댑터
  - 도메인 이벤트 발행 어댑터: 이벤트를 메시지 브로커에 발행하는 아웃바운드 어댑터
  
### 5.1.1 비지니스 로직 설계: 트랜잭션 스크립트 패턴
- 객체 지향 설계를 하지 않고 트랜잭션 스크립트라는 메서드를 작성하여 표현 계층에서 들어온 요청을 처리하는 것
- 이 방법은 구현된 클래스와 상태를 보관하는 클래스가 따로 존재하는 특징이 있다. 

### 5.1.2 비지니스 로직 설계: 도메인 모델 패턴 
- 객체 지향적으로 설계한 비지니스 로직은 비교적 작은 클래스가 그물망처럼 얽힌 객체 모델로 구성된다. 
- 상태, 동작 둘 중 하나만 있는 클래스도 있지만 대부분 상태/동작 모두 가지고 있다. 

### 5.1.3 도메인 주도 설계 개요
- DDD 방식으로 설계하면 각 서비스는 자체 도메인 모델을 가지며, 애플리케이션 전체 도메인 모델의 문제점을 방지할 수 있다. 
- DDD 에서 도메인 모델을 구축하는 데 흔히 쓰이는 빌딩 블록
  - 엔티티: 영속적인 신원을 가진 객체, 두 엔티티가 속성 값이 동일해도 다른 객체
  - 밸류 객체: 여러 값을 모아놓은 객체 (예: 통화와 금액으로 구성된 money 클래스)
  - 팩토리: 일반 생성자로 직접 만들기에 복잡한 객체 생성 로직이 구현된 객체 또는 메서드, 인스턴스로 생성할 구상 클래스를 감출 수 있다
  - 리포지토리
  - 서비스

## 5.2 도메인 모델 설계: DDD 애그리거트 패턴
- 애그리거트란 관련된 객체들을 모아 하나의 단위로 취급하는 개념

### 5.2.1 불분명한 경계 문제
### 5.2.2 애그리거트는 경계가 분명하다.
- 애그리거트는는 한 단위로 취급 가능한 경계 내부의 도메인 객체들으로 하나의 루트 엔티티와 하나 이상의 기타 엔티티 + 벨류 객체로 구성된다. 
- 애그리거트는 도메인 모델을 개별적으로 이해하기 쉬운 덩어리 분해한다. 

#### 5.2.2.1 애그리거트는 일관된 경계 
- 일부가 아니라 전체 애그리거트를 업테이트하므로 좀 전에 설명한 일관성 문제가 해소된다. 
- 업데이트 작업은 애그리거트 루트에서 호출되기 떄문에 불변 값이 강제되고, 동시성 역시 애그리거트 루트를 잠금하여 처리한다.

### 5.2.3 애그리거트 규칙

#### 규칙 #1: 애그리거트 루트만 참조하라
- 외부 클래스는 반드시 애그리거트의 루트 엔티티만 참조할 수 있게 제한해야 한다. 

#### 규칙 #2: 애그리거트 간 참조는 반드시 기본키를 사용하라
- 객체 레퍼런스 대신 신원(id)을 사용하면, 애그리거트는 느슨하게 결합되고, 경계가 분명해져서 다른 애그리거트를 업데이트 하지 않는다.

#### 규칙 #3: 하나의 트랜잭션으로 하나의 애그리거트를 생성/수정해라

### 5.2.4 애그리거트 입도
- 애그리거트는 작으면 작을수록 좋다. 동시 처리 가능한 요청 개수가 늘고 확장성이 좋아진다. 
- 두 사용자가 동시에 같은 애그리거트를 업데이트하다가 충돌할 가능성도 줄기 때문에 UX 면에서도 좋다. 

### 5.2.5 비지니스 로직 설계: 애그리거트
- 마이크로서비스 비지니스 로직은 대부분 애그리거트로 구성되며, 나머지는 도메인 서비스와 사가에 위치한다.
- 비지니스 로직은 Order 애그리거트, OrderService, OrderRepository, 하나 이상의 사가들로 구성된다. 

## 5.3 도메인 이벤트 발생 
- DDD 맥락에서는 도메인 이벤트는 애그리거트에 발생한 사건입니다. 
- 도메인 이벤트는 도메인 모델에서 클래스로 표현되며, 대부분 어떤 상태 변경을 나타낸다.

### 5.3.1 변경 이벤트 발행하는 이유
- 다른 구성원들이 에그리거트의 상태 변경을 궁금해 하기 때문에 도메인 이벤트는 유용하다.      
- 코레오그래피 사가를 이용하여 어러 서비스 데이터 일관성 유지
- 레플리카를 둔 서비스에 데이터 변경을 알림

### 5.3.2 도메인 이벤트란 무엇인가? 
- 도메인 이벤트는 과거 분사형 동사로 명명한 클래스입니다. 
- 이벤트에 의미를 부여하는 프로퍼티가 있는데, 프로퍼티는 원시 값 또는 벨류 객체 입니다. 

### 5.3.3 이벤트 강화 
- 이벤트 컨슈머가 서비스를 쿼리해서 애그리거트를 조회하는 것은 오버헤드를 유발하게 되므로, 필요한 정보를 이벤트가 가지고 다니는 이벤트 강화 기법을 적용할 수 있다. 

### 5.3.4 도메인 이벤트 식별
- FTGO 애플리케이션도 주문이 접수되면 소비자에게 이메일을 전송하라 라는 요건이 있을 수 있다. 

### 5.3.5 도메인 이벤트 생성 및 발행 
#### 도메인 이벤트 생성
- 개념적으로 도메인 이벤트는 에그리거트가 발행한다. 다만 에거리거트는 의존성 주입을 할 수 없기 때문에 메시징 API를 메서드 인수로 전달해야 하는 문제가 있다. 
- 따라서 에그리거트와 호출하는 서비스(또는 동등한 클래스)의 책임을 분리하는 것이 좋다. 

#### 도메인 이벤트를 확실하게 발행하는 법
- 서비스는 DB에서 애그리거트를 업데이트하는 트랜잭션의 일부로 이벤트를 발행하기 위해 트랜잭션널 메시징을 사용해야 한다. 

### 5.3.6 도메인 이벤트 소비 
- 도메인 이벤트는 결국 메시지로 바뀌어 아파치 카프카 같은 메시지 브로커에 발행된다. 


## 5.4 주방 서비스 비지니스 로직 
- 주방 서비스는 음식점이 주문을 관리할 수 있게 해주는 서비스로 Restaurant 애그리거트와 Ticket 애그리거트가 이 서비스의 메인 에그리거트이다.
- KitchenService, TicketRepository, RestaurantRepository 등의 주요 비지니스가 존재한다. 
- 인바운드 어뎁터
  - REST API 
  - KitchenServiceCommandHandler: 사가를 호출하는 비동기 요청/응답 API 
  - KitchenEventConsumer: RestaurantService 가 발행한 이벤트를 구독
- 아웃바운드 어댑터
  - DB 어뎁터
  - DomainEventPublishingAdapter: Ticket 의 도메인 이벤트를 발행

### 5.4.1 Ticket 애그리거트 
- Ticket 애그리거트는 음식점 주방 관점에서 바라본 주문을 나타낸 것이다. 

#### Ticket 클래스 구조 
- 기존 도메인 클래스와 비슷하지만 다른 애그리거트를 기본키로 참조하는 차이가 존재한다. 

#### Ticket 애그리거트 동작
- 음식점이 주문을 접수
- 음식점이 주문을 준비하기 시작했다 (변경 불가)
- 주문 픽업 준비가 끝남

#### KitchenService 도메인 서비스 
- KitchenService는 주방 서비스의 인바운드 어댑터가 호출합니다. 주문 상태를 변경하는 메서드는 각각 애그리거트를 가져와 루트에 있는 해당 메서드를 호출한 후 도메인 이벤트를 발생한다.

#### KitchenServiceCommandHandler 클래스 
- 주문 서비스에 구현된 사가가 전송한 커맨드 메시지를 처리하는 어댑터이다. 
- KitchenService 를 호출하여 Ticket 생성/수정하는 핸들러 메서드가 커맨들별로 저장되어 있다.

## 5.5 주문 서비스 비지니스 로직 
- 주문 서비스는 주문을 생성, 수정, 취소하는 API 를 제공하는 서비스이다. 
- Order 애그리거트가 중심을 차지하고 음식점 서비스 데이터의 부분 레플리카인 Restaurant 애그리거트도 있다. 
- OrderService, OrderRepository, RestaurantRepository, CreateOrderSaga 등으로 구성된다.
- 인바운드 어댑터
  - REST API
  - OrderEventConsumer: 음식점 서비스가 발행한 이벤트를 구독
  - OrderCommandHandler: 사가가 호출하는 비동기 요청/응답 기반의 API
  - SagaReplyAdapter: 사가 응답 채널을 구독하고 사가를 호출한다.
- 아웃바운드 어댑터
  - DB 어댑터
  - DomainEventPublishingAdapter: Order 도메인 이벤트 발행
  - OutboundCommandMessageAdapter: 커맨드 메시지를 사가 참여자에게 보낸다.

### 5.5.1 Order 애그리거트
- 소비자가 한 주문을 나타낸다. 

#### 구조
- Order 클래스가 애그리거트 루트고, OrderLineItem, DeliveryInfo, PaymentInfo 등의 벨류 객체
- Consumer, Restaurant 는 상이한 에그리거트로 기본키 값으로 상호 참조

#### Order 애그리거트 상태 기계
- 주문을 생성/수정시 반드시 다른 서비스와 사가로 협동해야 한다. 
- APPROVAL_PENDING 이라는 초기상태는 중간 계류 상태이며 이는 시멘틱 락 대책을 적용하기 위해서이다. 
- 다른 서비스에 처리 결과에 따라 락이 해제 된다. 
- CANCEL_PENDING, REVISION_PENDING 단계들 역시 계류상태로 다른 요청시 락이 걸리게 된다. 


