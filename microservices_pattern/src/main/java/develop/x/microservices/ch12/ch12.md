# 12장 마이크로서비스 배포
- 프로덕션 환경의 4대 필수 기능
  - 서비스 관리 인터페이스
  - 런타임 서비스 관리
  - 모니터링
  - 요청 라우팅

## 12.1 서비스 배포: 언어에 특정한 패키징 포맷 패턴 
- 언어에 특정한 패키지 형태로 프로덕션에 배포하는 패턴

### 12.1.1 언어에 특정한 패키징 포맷 패턴의 장점
- 배포가 빠르다.
- 리소스를 효율적으로 사용할 수 있다. 

### 12.1.2 언어에 특정한 패키징 포맷 패턴의 단점
- 기술 스택을 캡슐화 할 수 없다.
- 서비스 인스턴스가 소비하는 리소스를 제한할 방법이 없다.
- 여러 서비스 인스턴스가 동일 머신에서 실행되는 경우 서로 격리할 수 없다. 
- 서비스 인스턴스를 어디에 둘지 자동으로 결정하기 어렵다. 


## 12.2 서비스 배포: 가상머신 패턴
- 서비스를 VM 이미지로 묶어 프로덕션에 배포한다. 각 서비스 인스턴스가 하나의 VM이다.

### 12.2.1 서비스 배포: 가상머신 패턴 장점
- VM 이미지로 기술 스택을 캡슐화
- 서비스 인스턴스가 격리
- 성숙한 클라우드 인프라 활용

### 12.2.2 서비스 배포: 가상머신 패턴 단점
- 리소스를 효율적으로 활용할 수 없다.
- 배포가 비교적 느리다.
- 시스템 관리 오베헤드 발생

## 12.3 서비스 배포: 컨테이너 패턴
- 서비스를 컨테이너 이미지로 묶어 프로덕션에 배포한다. 각 서비스 인스턴스가 하나의 컨테이너이다.
- 컨테이너는 가벼운 배포 수단으로 OS 수준에서 가상화한 매커니즘이다. 
- 가장 유명한 컨테이너 런타임은 도커이다.

### 12.3.1 서비스를 도커로 배포
- 컨테이너 이미지는 애플리케이션과 서비스 구동에 필요한 모든 소프트웨어로 구성된 파일 시스템 이미지이다. 
- 스프링 부트 서비스는 실행가능한 jar, 정확한 버전의 JDK가 들어있는 컨테이너 이미지를 빌드해서 배포한다.

#### 도커 이미지 빌드 
- 도커 컨테이너 이미지를 빌드하는 방법이 기술된 도커파일을 생생해야 된다. 

#### 도커 이미지를 레지스트리에 푸시 
- 도커 레지스트리는 자바 라이브러기 집합된 메이픈 저장소나 Node.js 패키지가 모여 있는 npm 레지스트리 같은 것이다. 

#### 도커 컨테이너 실행
- 컨테이너를 생성/시동하는 커맨드는 `run`이다. 
- 필요시 레지스트리에서 이미지를 당겨온다. 컨테이너 생성/시도되면 도커파일에 지정된 java -jar 커맨드가 실행된다. 

### 12.3.2 장점
- 기술 스팩의 캡슐화 서비스 관리 API가 곧 컨테이너 API가 된다. 
- 서비스 인스턴스 격리
- 서비스 인스턴스의 리소스를 제한

### 12.3.3 단점
- 컨테이너 이미지를 직접 관리해야 된다.

## 12.4 쿠버네티스
- 도커 오케스트레이션 프레임워크로서 도커를 기반으로 여러 머신을 하나의 서비스 실행 리소스 풀로 전환하는 소프트웨어 계층이다.
### 12.4.1 개요
- 리소스 관리: 여러 머신을 CPU, 메모리, 스토리지 볼륨을 묶어 놓은 하나의 리소스 풀로 취급
- 스케줄링: 컨테이너를 실행할 머신을 선택한다. 
  - 컨테이너의 리소스 요건 및 노드별 리소스 상황에 따라 결정된다. 
  - 유사성을 찾아 여러 컨테이너를 같은 노드에 배치하거나 반유사성을 발견하여 다른 노드로 옮긴다. 
- 서비스 관리: 마이크로서비스에 직접 매핑되는 서비스를 명명하고 버저닝한다. 
  - 정상 인스턴스를 항상 적정하게 유지하고 부하를 인스턴스에 고루 분산한다. 

#### 아키텍처
- 쿠버네티스 클러스터의 머신은 마스터, 노드 둘중 하나이다. 클러스터는 대부분 소수의 마스터와 하나 이상의 노드로 구성
- 마스터는 클러스터를 광장하며, 노드는 하나 이상의 파드를 실행하는 워커이다.
- 파드는 여러 컨테이너로 구성된 구버네티스의 배포 단위
- 마스터는 다음 컴포넌트를 실행한다.
  - API 서버: kubect1 CLI에서 사용하는 서비스 배포/관리용 REST API
  - etcd: 클러스터 데이터를 저장하는 키 값 NoSQL DB
  - 스케줄러: 파드를 실행할 노드를 선택
  - 컨트롤러 관리자: 컨트롤러는 클러스터가 원하는 상태가 되도록 제어한다.
- 노드는 다음 컴포넌트를 실행한다.
  - 큐블릿: 노드에서 실행되는 파드를 생성/관리한다.
  - 큐브 프록시: 여러 파드에 부하를 분산하는 네트워킹 관리
  - 파드: 애플리케이션 서비스 

#### 쿠버네티스 핵심개념
- 파드(pod): 
  - 쿠버네티스의 기본 배포 단위, IP 주소, 스토리지 볼륨을 공유하는 하나이상의 컨테이너로 구성된다. 
  - 서비스 인스턴스 파드는 보통 JVM 실행 컨테이너처럼 하나의 컨테이너로 구성하지만 사이드카 컨테이너가 포함될 수 있다.
- 디플로이먼트:
  - 파드의 선언형 명세이다. 
  - 항상 파드 인스턴스를 원하는 개수만큼 실행시키는 컨트롤러이다. 
- 서비스: 
  - 클라이언트에 안정된 정적 네트워크 위치를 제공한다. 
  - IP 주소와 이 주소로 해석되는 DNS 명이 할당된 서비스는 TCP/UDP 트래픽을 하나 이상의 파드에 고루 분산한다.
- 컨피그맵:
  - 하나 이상의 애플리케이션 서비스에 대한 외부화 구성이 정의된 이름-값 쌍의 컬렉션이다.

### 12.4.5 배포와 릴리스 분리:서비스 매시
- 1 최종 사용자 요청을 서비스에 라우팅하지 않고 새 버전의 서비스를 프로덕션에 배포
- 2 프로덕션에서 새 버전을 테스트
- 3 소수에 사용자에게만 새 버전을 릴리즈
- 4 모든 운영 트래픽을 소화할 때까지 점점 더 많은 사용자에게 릴리즈
- 5 어딘가 문제가 생기면 구 버전으로 돌린다. 


## 12.5 서비스 배포: 서버리스 패턴

### 12.5.1 AWS 람다를 이용한 서버리스 배포
- 퍼블릭 클라우드에서 제공하는 서버리스 배포 매커니즘을 이용하여 서비스를 배포한다.


